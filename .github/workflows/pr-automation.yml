name: PR Automation (Title & Notion)

on:
  pull_request_target:
    types: [opened, reopened, closed, edited]

permissions:
  pull-requests: write

jobs:
  automate-pr:
    runs-on: ubuntu-latest
    steps:
      # 1. PR 제목 자동 수정
      - name: Auto-format PR Title
        id: format-title
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            const branchName = pr.head.ref;
            let finalTitle = pr.title;

            // Opened/Reopened일 때만 제목 변경 시도
            if (context.payload.action === 'opened' || context.payload.action === 'reopened') {
              if (!finalTitle.startsWith('[')) {
                const regex = /^([a-z]+)\/(ODS-\d+).*/i;
                const match = branchName.match(regex);
                if (match) {
                  const type = match[1];
                  const odsId = match[2];
                  finalTitle = `[ODS-${odsId.split('-')[1]}] ${type}: ${pr.title}`; // ODS-3 형식 보장
                  
                  await github.rest.pulls.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pr.number,
                    title: finalTitle
                  });
                }
              }
            }

            // ⭐ 중요: 최종 제목을 다음 단계로 넘김
            core.setOutput('final_title', finalTitle);

      # 2. 노션 업데이트 (전달받은 제목 사용)
      - name: Update Notion Status & Link
        uses: actions/github-script@v6
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: '2f841807241280379e84f43daa636edb'
          FINAL_TITLE: ${{ steps.format-title.outputs.final_title }} # 여기서 받음!
        with:
          script: |
            const https = require('https');

            // 전달받은 제목 사용 (없으면 원래 제목)
            const title = process.env.FINAL_TITLE || context.payload.pull_request.title;
            const body = context.payload.pull_request.body || "";
            const prUrl = context.payload.pull_request.html_url;

            console.log(`Analyzing Title: ${title}`); // 로그로 확인

            const NOTION_API_KEY = process.env.NOTION_API_KEY;
            const DATABASE_ID = process.env.NOTION_DATABASE_ID;

            const regex = /ODS-(\d+)/i;
            const match = title.match(regex) || body.match(regex);

            if (!match) {
              console.log("No Notion ID found. Skipping.");
              return;
            }

            const issueId = parseInt(match[1], 10);
            console.log(`Processing ODS-${issueId}`);

            // (이하 노션 API 호출 로직은 동일)
            let newStatus = null;
            if (context.payload.action === 'opened' || context.payload.action === 'reopened') {
               newStatus = '진행중';
            } else if (context.payload.action === 'closed' && context.payload.pull_request.merged) {
               newStatus = '완료';
            }

            if (!newStatus) return;

            function notionRequest(method, path, body) {
              return new Promise((resolve, reject) => {
                const req = https.request({
                  hostname: 'api.notion.com',
                  path: '/v1' + path,
                  method,
                  headers: {
                    'Authorization': `Bearer ${NOTION_API_KEY}`,
                    'Notion-Version': '2022-06-28',
                    'Content-Type': 'application/json'
                  }
                }, res => {
                  let data = '';
                  res.on('data', c => data += c);
                  res.on('end', () => resolve(JSON.parse(data)));
                });
                req.on('error', reject);
                if (body) req.write(JSON.stringify(body));
                req.end();
              });
            }

            async function main() {
              const queryRes = await notionRequest('POST', `/databases/${DATABASE_ID}/query`, {
                filter: { property: "ID", unique_id: { equals: issueId } }
              });

              if (!queryRes.results || queryRes.results.length === 0) {
                 console.log(`Page not found for ODS-${issueId}`);
                 return;
              }

              const pageId = queryRes.results[0].id;
              
              await notionRequest('PATCH', `/pages/${pageId}`, {
                properties: {
                  "상태": { status: { name: newStatus } },
                  "PR 링크": { url: prUrl }
                }
              });
              console.log(`Updated status to ${newStatus}`);
            }

            await main();

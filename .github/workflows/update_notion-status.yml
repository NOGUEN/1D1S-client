name: Branch Automation (Notion Status)

on:
  create:

jobs:
  update-notion-on-branch:
    # 브랜치 생성일 때만 실행 (태그 제외)
    if: github.event.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Update Notion Status to 진행중
        uses: actions/github-script@v6
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_API_KEY }}
          NOTION_DATABASE_ID: '2f841807241280379e84f43daa636edb'
        with:
          script: |
            const https = require('https');

            const branchName = context.ref; // create 이벤트는 context.ref에 브랜치명
            console.log(`Branch created: ${branchName}`);

            const regex = /ODS-(\d+)/i;
            const match = branchName.match(regex);

            if (!match) {
              console.log("No Notion ID found in branch name. Skipping.");
              return;
            }

            const issueId = parseInt(match[1], 10);
            console.log(`Processing ODS-${issueId}`);

            const NOTION_API_KEY = process.env.NOTION_API_KEY;
            const DATABASE_ID = process.env.NOTION_DATABASE_ID;

            function notionRequest(method, path, body) {
              return new Promise((resolve, reject) => {
                const req = https.request({
                  hostname: 'api.notion.com',
                  path: '/v1' + path,
                  method,
                  headers: {
                    'Authorization': `Bearer ${NOTION_API_KEY}`,
                    'Notion-Version': '2022-06-28',
                    'Content-Type': 'application/json'
                  }
                }, res => {
                  let data = '';
                  res.on('data', c => data += c);
                  res.on('end', () => resolve(JSON.parse(data)));
                });
                req.on('error', reject);
                if (body) req.write(JSON.stringify(body));
                req.end();
              });
            }

            async function main() {
              const queryRes = await notionRequest('POST', `/databases/${DATABASE_ID}/query`, {
                filter: { property: "ID", unique_id: { equals: issueId } }
              });

              if (!queryRes.results || queryRes.results.length === 0) {
                console.log(`Page not found for ODS-${issueId}`);
                return;
              }

              const pageId = queryRes.results[0].id;

              await notionRequest('PATCH', `/pages/${pageId}`, {
                properties: {
                  "상태": { status: { name: "진행중" } }
                }
              });
              console.log(`Updated ODS-${issueId} status to 진행중`);
            }

            await main();
